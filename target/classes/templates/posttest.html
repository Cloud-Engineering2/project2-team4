<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</title>
    <script>
    function getUserIdFromToken() {
        let token = localStorage.getItem("token");
        if (!token) return null;

        try {
            let payload = JSON.parse(atob(token.split('.')[1])); // Base64 ë””ì½”ë”©
            console.log("ğŸ“Œ ë””ì½”ë”©ëœ JWT Payload:", payload); // ë””ë²„ê¹…ìš© ë¡œê·¸
            return payload.uid || null; // âœ… "uid" ê°’ ê°€ì ¸ì˜¤ê¸°
        } catch (error) {
            console.error("í† í° ë””ì½”ë”© ì‹¤íŒ¨:", error);
            return null;
        }
    }

    async function uploadFile() {
        let formData = new FormData();

        // ğŸ“Œ í† í° ê°€ì ¸ì˜¤ê¸°
        let token = localStorage.getItem("token");
        if (!token) {
            alert("âŒ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”!");
            return;
        }

        // ğŸ“Œ í† í°ì—ì„œ uid ì¶”ì¶œ
        let userId = getUserIdFromToken();
        if (!userId) {
            alert("âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”!");
            return;
        }

        // ì…ë ¥ í•„ë“œ ê°€ì ¸ì˜¤ê¸°
        let fileInput = document.getElementById("file");
        let titleInput = document.getElementById("title");
        let contentInput = document.getElementById("content");
        let linkInput = document.getElementById("link");

        let file = fileInput.files[0];
        let title = titleInput.value.trim();
        let content = contentInput.value.trim();
        let link = linkInput.value.trim();

        // í•„ìˆ˜ê°’ ì²´í¬
        if (!file) {
            alert("ğŸ“Œ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤!");
            return;
        }
        if (!title) {
            alert("ğŸ“Œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");
            titleInput.focus();
            return;
        }
        if (!content) {
            alert("ğŸ“Œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!");
            contentInput.focus();
            return;
        }

        // âœ… JSON ë°ì´í„° ìƒì„± (í† í°ì—ì„œ ê°€ì ¸ì˜¨ uidë¥¼ user.idë¡œ ì„¤ì •)
        let postData = {
            user: { id: userId },  // âœ… ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ UID ë°˜ì˜
            category: { id: 3 },
            title: title,
            content: content,
            link: link
        };

        // FormDataì— ì¶”ê°€
        formData.append("file", file);
        formData.append("post", new Blob([JSON.stringify(postData)], { type: "application/json" }));

        try {
            console.log("ğŸ“Œ ì „ì†¡í•  ë°ì´í„°:", postData);

            let response = await fetch("/api/post", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                },
                body: formData
            });

            let responseText = await response.text();
            console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ:", responseText);

            if (!response.ok) {
                throw new Error("ì„œë²„ ì˜¤ë¥˜: " + response.status);
            }

            try {
                let jsonData = JSON.parse(responseText);
                alert("âœ… ì—…ë¡œë“œ ì„±ê³µ! ê²Œì‹œê¸€ ID: " + jsonData.id);
            } catch (error) {
                console.error("ğŸ“Œ JSON íŒŒì‹± ì‹¤íŒ¨:", error);
                alert("âš  ì„œë²„ ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
            }

        } catch (error) {
            console.error("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨! " + error.message);
        }
    }

    </script>
</head>
<body>
    <h2>íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h2>
    
    <label for="title">ì œëª©:</label>
    <input type="text" id="title"><br>

    <label for="content">ë‚´ìš©:</label>
    <textarea id="content"></textarea><br>

    <label for="link">ë§í¬:</label>
    <input type="text" id="link"><br>

    <label for="file">íŒŒì¼ ì—…ë¡œë“œ:</label>
    <input type="file" id="file"><br>

    <button onclick="uploadFile()">ì „ì†¡</button>
</body>
</html>
