<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ëª©ë¡</title>
    <link rel="stylesheet" th:href="@{/css/init.css}">
    <link rel="stylesheet" th:href="@{/css/gallery.css}">
</head>

<body>
    <div th:replace="~{fragments/nav}"></div>

    <div class="main-box">
        <div class="button-box">
            <div class="filter-btn">Filter</div>
            <div class="edit-btn">ShowU</div>
            <div class="dropdown-menu"></div>
        </div>
    </div>

    <div th:replace="~{fragments/footer}"></div>
    <div th:replace="~{fragments/back}"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const mainBox = document.querySelector('.main-box');
            const filterBtn = document.querySelector('.filter-btn');
            const dropdownMenu = document.querySelector('.dropdown-menu');
            const editBtn = document.querySelector('.edit-btn');

            let allPosts = [];
            let top5Posts = [];

            // âœ… ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            try {
                const postsRes = await fetch("/api/post");
                allPosts = await postsRes.json();
                top5Posts = [...allPosts].sort((a, b) => b.likes - a.likes).slice(0, 5);

                renderPosts("ì´ë²ˆ ì£¼ ìµœê³ ì˜ ìë‘ Top5", top5Posts);
                renderPosts("All Post", allPosts, true);
                
                loadCategories();
            } catch (error) {
                console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            }

            // âœ… ê²Œì‹œê¸€ ëª©ë¡ ë Œë”ë§
            function renderPosts(title, posts, isAllPost = false) {
                const container = document.createElement("div");
                container.classList.add("ct-box");
                if (isAllPost) container.classList.add("all-post");

                const titleElem = document.createElement("p");
                titleElem.classList.add("ct-title");
                titleElem.textContent = title;

                const postBox = document.createElement("div");
                postBox.classList.add("pt-box");

                posts.forEach(post => postBox.appendChild(createPostItem(post)));

                container.append(titleElem, postBox);
                mainBox.appendChild(container);
            }

            // âœ… ê²Œì‹œê¸€ ì•„ì´í…œ ìƒì„±
            function createPostItem(post) {
                const postItem = document.createElement("div");
                postItem.classList.add("post-item");

                const img = document.createElement("img");
                img.src = post.imageUrl;
                img.alt = "Post Image";

                const iconBox = document.createElement("div");
                iconBox.classList.add("post-icon-box");

                const likeIcon = document.createElement("img");
                likeIcon.classList.add("icon", "like");
                likeIcon.src = "/icons/like.png";
                likeIcon.alt = "like";
                likeIcon.dataset.postId = post.id;

                const likeText = document.createElement("span");
                likeText.classList.add("like-text");
                likeText.textContent = post.likes;

                const detailBtn = document.createElement("div");
                detailBtn.classList.add("btn");
                detailBtn.textContent = "Detail";
                detailBtn.addEventListener("click", () => window.location.href = `/detail/${post.id}`);

                likeIcon.addEventListener("click", async () => {
                    try {
                        const res = await fetch(`/api/post/like/${post.id}`, { method: "PATCH", headers: { "Content-Type": "application/json" } });
                        if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");

                        const data = await res.json();
                        likeText.textContent = data.likes;
                        window.location.reload();
                    } catch (error) {
                        console.error("ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                    }
                });

                iconBox.append(likeIcon, likeText, detailBtn);
                postItem.append(img, iconBox);
                return postItem;
            }

            // âœ… ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° & ë“œë¡­ë‹¤ìš´ ì¶”ê°€
            async function loadCategories() {
                try {
                    const categoriesRes = await fetch("/api/admin/categories");
                    const categories = await categoriesRes.json();

                    dropdownMenu.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

                    // "All Posts" í•„í„° ì¶”ê°€
                    addCategoryFilter("All Posts", allPosts);

                    categories.forEach(category => addCategoryFilter(category.name, allPosts.filter(post => post.category?.name === category.name)));
                } catch (error) {
                    console.error("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                }
            }

            // âœ… í•„í„° ë²„íŠ¼ ì¶”ê°€
            function addCategoryFilter(categoryName, posts) {
                const item = document.createElement("div");
                item.classList.add("dropdown-item");
                item.textContent = categoryName;
                dropdownMenu.appendChild(item);
            }

            // âœ… í•„í„°ë§ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
            dropdownMenu.addEventListener("click", (event) => {
			    if (event.target.classList.contains("dropdown-item")) {
			        const categoryName = event.target.textContent;
			        
			        // ğŸ”¥ ê¸°ì¡´ ë‚´ìš©ì„ ìœ ì§€í•˜ë©´ì„œ ê²Œì‹œê¸€ ëª©ë¡ë§Œ ê°±ì‹ 
			        const postContainers = document.querySelectorAll(".ct-box");
			        postContainers.forEach(box => box.remove()); // ê¸°ì¡´ ê²Œì‹œê¸€ë§Œ ì‚­ì œ
			
			        renderPosts("ì´ë²ˆ ì£¼ ìµœê³ ì˜ ìë‘ Top5", top5Posts);
			        renderPosts(`Category: ${categoryName}`, categoryName === "All Posts" ? allPosts : allPosts.filter(post => post.category?.name === categoryName), true);
			
			        dropdownMenu.style.display = "none";
			    }
			});

            // âœ… ë“œë¡­ë‹¤ìš´ í† ê¸€
            filterBtn.addEventListener("click", () => {
                dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
            });

            // âœ… ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener("click", (event) => {
                if (!filterBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.style.display = "none";
                }
            });

            // âœ… ê¸€ ì‘ì„± ë²„íŠ¼ í´ë¦­ ì‹œ
            editBtn.addEventListener("click", () => {
                const token = localStorage.getItem("token");
                if (!token) {
                    alert("âŒ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”!");
                    location.href = "/login";
                } else {
                    location.href = "/postupload";
                }
            });
        });
    </script>
</body>

</html>
