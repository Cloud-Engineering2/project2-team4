<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì‹œê¸€ ëª©ë¡</title>
    <link rel="stylesheet" th:href="@{/css/init.css}">
    <link rel="stylesheet" th:href="@{/css/gallery.css}">
</head>
<script>
document.addEventListener('DOMContentLoaded', async function () {
    // ğŸ“Œ DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const mainBox = document.querySelector('.main-box');  // ê²Œì‹œê¸€ì´ ì¶”ê°€ë  ë©”ì¸ ë°•ìŠ¤
    const filterBtn = document.querySelector('.filter-btn');  // í•„í„° ë²„íŠ¼
    const dropdownMenu = document.querySelector('.dropdown-menu');  // ì¹´í…Œê³ ë¦¬ ë“œë¡­ë‹¤ìš´
    const editBtn = document.querySelector('.edit-btn'); // ê¸€ ì‘ì„± ë²„íŠ¼
    
    let allPosts = [];  // ì „ì²´ ê²Œì‹œê¸€ ì €ì¥
    let categories = [];  // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì €ì¥

    // âœ… ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    try {
        // ğŸ”¥ ëª¨ë“  ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
        const postsRes = await fetch("/api/post");
        allPosts = await postsRes.json();

        // ğŸ”¥ ì¢‹ì•„ìš” ìˆœ ì •ë ¬ (Top 5)
        const top5Posts = [...allPosts].sort((a, b) => b.likes - a.likes).slice(0, 5);

        // âœ… ì´ˆê¸° UI ë Œë”ë§
        mainBox.appendChild(createPostContainer("All Post Weekly Top5", top5Posts));

        const allPostBox = createPostContainer("All Post", allPosts);
        allPostBox.classList.add("all-post");  // ğŸ”¥ all-post í´ë˜ìŠ¤ ì¶”ê°€
        mainBox.appendChild(allPostBox);

        // âœ… ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        loadCategories();
    } catch (error) {
        console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }

    // âœ… ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° & ë“œë¡­ë‹¤ìš´ ì¶”ê°€
    async function loadCategories() {
        try {
            const categoriesRes = await fetch("/api/admin/categories");
            categories = await categoriesRes.json();

            dropdownMenu.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

            categories.forEach(category => {
                const item = document.createElement("div");
                item.classList.add("dropdown-item");
                item.textContent = category.name;
                item.addEventListener("click", () => filterByCategory(category.name)); // í´ë¦­ ì‹œ í•„í„° ì ìš©
                dropdownMenu.appendChild(item);
            });
        } catch (error) {
            console.error("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
    }

    // âœ… íŠ¹ì • ì¹´í…Œê³ ë¦¬ ê²Œì‹œê¸€ í•„í„°ë§
    function filterByCategory(categoryName) {
        console.log(`ğŸ” ì„ íƒëœ ì¹´í…Œê³ ë¦¬: ${categoryName}`);

        const filteredPosts = allPosts.filter(post => {
            console.log(`âœ… ê²Œì‹œê¸€ ì¹´í…Œê³ ë¦¬ ê°’:`, post.category);
            return post.category && post.category.name === categoryName;
        });

        console.log("ğŸ“Œ í•„í„°ëœ ê²Œì‹œê¸€ ëª©ë¡:", filteredPosts);
        updateAllPostBox(categoryName, filteredPosts);
    }

    // âœ… All Post ë°•ìŠ¤ ì—…ë°ì´íŠ¸
    function updateAllPostBox(categoryName, posts) {
        // ğŸ”¥ ê¸°ì¡´ì˜ ëª¨ë“  .all-post ì œê±°
        document.querySelectorAll(".ct-box.all-post").forEach(box => box.remove());

        const newAllPostBox = createPostContainer(`Category: ${categoryName}`, posts);
        newAllPostBox.classList.add("all-post");  // ğŸ”¥ ìƒˆ ë°•ìŠ¤ë„ all-postë¡œ ì„¤ì •
        mainBox.appendChild(newAllPostBox);
    }

    // âœ… ê²Œì‹œê¸€ ì»¨í…Œì´ë„ˆ ìƒì„± í•¨ìˆ˜
    function createPostContainer(titleText, postList) {
        const container = document.createElement("div");
        container.classList.add("ct-box");

        const title = document.createElement("p");
        title.classList.add("ct-title");
        title.textContent = titleText;

        const ptBox = document.createElement("div");
        ptBox.classList.add("pt-box");

        postList.forEach(post => {
            const postItem = createPostItem(post);
            ptBox.appendChild(postItem);
        });

        container.append(title, ptBox);
        return container;
    }

    // âœ… ê²Œì‹œê¸€ ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
    function createPostItem(post) {
        const postItem = document.createElement("div");
        postItem.classList.add("post-item");

        const img = document.createElement("img");
        img.src = post.imageUrl;
        img.alt = "Post Image";

        const iconBox = document.createElement("div");
        iconBox.classList.add("post-icon-box");

        const likeIcon = document.createElement("img");
        likeIcon.classList.add("icon", "like");
        likeIcon.src = "/icons/like.png";
        likeIcon.alt = "like";
        likeIcon.dataset.postId = post.id;

        const likeText = document.createElement("span");
        likeText.classList.add("like-text");
        likeText.textContent = post.likes;

        const btn = document.createElement("div");
        btn.classList.add("btn");
        btn.textContent = "Detail";
        btn.addEventListener("click", () => {
            window.location.href = `/api/post/${post.id}`;
        });

        likeIcon.addEventListener("click", async () => {
            const postId = likeIcon.dataset.postId;
            try {
                const res = await fetch(`/api/post/like/${postId}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" }
                });

                if (!res.ok) {
                    throw new Error("ì„œë²„ ì˜¤ë¥˜");
                }

                const data = await res.json();
                likeText.textContent = data.likes;
                window.location.href = "/gallery";
            } catch (error) {
                console.error("ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
            }
        });

        iconBox.append(likeIcon, likeText, btn);
        postItem.append(img, iconBox);
        return postItem;
    }

    // âœ… ë“œë¡­ë‹¤ìš´ í† ê¸€ ê¸°ëŠ¥
    filterBtn.addEventListener('click', function () {
        dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    });

    // âœ… ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', function (event) {
        if (!filterBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
            dropdownMenu.style.display = 'none';
        }
    });
    
    editBtn.addEventListener("click", function () {
        let token = sessionStorage.getItem("token");
        if (!token) {
            alert("âŒ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”!");
            location.href = '/login';
            return;
        }
        location.href = '/postupload';
    });

});

</script>

<body>
    <div th:replace="~{fragments/nav}"></div>
    <div class="main-box">
                <div class="button-box">
            <div class="filter-btn">Filter</div>
            <div class="edit-btn">ShowU</div>
            <div class="dropdown-menu">
                <div class="dropdown-item"></div>
            </div>
        </div>
    </div>
    
    <div th:replace="~{fragments/footer}"></div>
<div th:replace="~{fragments/back}"></div>
</body>

</html>