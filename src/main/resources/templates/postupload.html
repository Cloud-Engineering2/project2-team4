<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>íŒŒì¼ ì—…ë¡œë“œ</title>
<link rel="stylesheet" type="text/css" href="/css/postupload.css">
<script>
document.addEventListener("DOMContentLoaded", function() {
    let token = localStorage.getItem("token");
    if (!token) {
        alert("âŒ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”!");
        location.href = '/login';
        return;
    }
	loadCategories();

    // ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ í´ë¦­ ì‹œ ì—´ê¸°
    document.getElementById("selectedCategory").addEventListener("click", function() {
        document.querySelector(".dropdown-content").classList.toggle("show");
    });

    // ë“œë¡­ë‹¤ìš´ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    window.addEventListener("click", function(event) {
        if (!event.target.matches(".dropbtn")) {
            document.querySelector(".dropdown-content").classList.remove("show");
        }
    });
});

    function getUserIdFromToken() {
        let token = sessionStorage.getItem("token");
        if (!token) return null;

        try {
            let payload = JSON.parse(atob(token.split('.')[1])); // Base64 ë””ì½”ë”©
            console.log("ğŸ“Œ ë””ì½”ë”©ëœ JWT Payload:", payload); // ë””ë²„ê¹…ìš© ë¡œê·¸
            return payload.uid || null; // âœ… "uid" ê°’ ê°€ì ¸ì˜¤ê¸°
        } catch (error) {
            console.error("í† í° ë””ì½”ë”© ì‹¤íŒ¨:", error);
            return null;
        }
    }

    async function uploadFile() {
        let formData = new FormData();
        let selectedCategory = document.getElementById("selectedCategory");
        let categoryId = selectedCategory.dataset.id; // ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ ID ê°€ì ¸ì˜¤ê¸°

        if (!categoryId) {
            alert("ğŸ“Œ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
            return;
        }

        // ğŸ“Œ í† í° ê°€ì ¸ì˜¤ê¸°
        let token = sessionStorage.getItem("token");
        if (!token) {
            alert("âŒ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”!");
            return;
        }

        // ğŸ“Œ í† í°ì—ì„œ uid ì¶”ì¶œ
        let userId = getUserIdFromToken();
        if (!userId) {
            alert("âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”!");
            return;
        }

        // ì…ë ¥ í•„ë“œ ê°€ì ¸ì˜¤ê¸°
        let fileInput = document.getElementById("file");
        let titleInput = document.getElementById("title");
        let contentInput = document.getElementById("content");
        let linkInput = document.getElementById("link");

        let file = fileInput.files[0];
        let title = titleInput.value.trim();
        let content = contentInput.value.trim();
        let link = linkInput.value.trim();

        // í•„ìˆ˜ê°’ ì²´í¬
        if (!file) {
            alert("ğŸ“Œ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤!");
            return;
        }
        if (!title) {
            alert("ğŸ“Œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");
            titleInput.focus();
            return;
        }
        if (!content) {
            alert("ğŸ“Œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!");
            contentInput.focus();
            return;
        }

        // ğŸ“Œ ì—…ë¡œë“œí•  ë°ì´í„°
        let postData = {
            user: { id: userId },
            category: { id: categoryId },
            title: title,
            content: content,
            link: link
        };

        // FormDataì— ì¶”ê°€
        formData.append("file", file);
        formData.append("post", new Blob([JSON.stringify(postData)], { type: "application/json" }));

        try {
            console.log("ğŸ“Œ ì „ì†¡í•  ë°ì´í„°:", postData);

            let response = await fetch("/api/post", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                },
                body: formData
            });

            let responseText = await response.text();
            console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ:", responseText);

            if (!response.ok) {
                throw new Error("ì„œë²„ ì˜¤ë¥˜: " + response.status);
            }

            try {
                let jsonData = JSON.parse(responseText);
                alert("âœ… ì—…ë¡œë“œ ì„±ê³µ! ê²Œì‹œê¸€ ID: " + jsonData.id);
                window.location.href = "/gallery";
            } catch (error) {
                console.error("ğŸ“Œ JSON íŒŒì‹± ì‹¤íŒ¨:", error);
                alert("âš  ì„œë²„ ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.");
            }

        } catch (error) {
            console.error("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨! ë¡œê·¸ì¸í•˜ì„¸ìš”!" + error.message);
            window.location.href = "/login";
        }
    }

    
    async function loadCategories() {
        try {
            const response = await fetch("/api/admin/categories");
            const categories = await response.json();

            const categoryMenu = document.getElementById("categoryMenu");
            const selectedCategory = document.getElementById("selectedCategory");

            categoryMenu.innerHTML = ""; // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”

            categories.forEach(category => {
                const item = document.createElement("div");
                item.textContent = category.name;
                item.dataset.id = category.id;
                item.classList.add("dropdown-item"); // ìŠ¤íƒ€ì¼ ì ìš©

                item.addEventListener("click", function() {
                    selectedCategory.textContent = category.name; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                    selectedCategory.dataset.id = category.id; // ì„ íƒí•œ ID ì €ì¥
                    categoryMenu.classList.remove("show"); // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                });

                categoryMenu.appendChild(item);
            });
        } catch (error) {
            console.error("âŒ ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
    }
    
    </script>
</head>
<body>
	<div th:replace="~{fragments/nav}"></div>
	<div></div>
	<div class="container">
		<h2>ìë‘í•˜ê¸°</h2>

		<div class="form-group">
			<label for="title">ì œëª©:</label> <input type="text" id="title">

			<div class="dropdown">
				<button class="dropbtn" id="selectedCategory">ì¹´í…Œê³ ë¦¬ ì„ íƒ</button>
				<div class="dropdown-content" id="categoryMenu"></div>
			</div>
			<br>

			<label for="content">ë‚´ìš©:</label>
			<textarea id="content"></textarea>
			<br> <label for="link">ë§í¬:</label> <input type="text" id="link"><br>

			<label for="file">íŒŒì¼ ì—…ë¡œë“œ:</label> <input type="file" id="file"><br>

			<button onclick="uploadFile()">ì „ì†¡</button>
		</div>
	</div>
	<div th:replace="~{fragments/footer}"></div>
	<div th:replace="~{fragments/back}"></div>
</body>
</html>
