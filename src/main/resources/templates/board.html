<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 목록</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/board.css">
    <script>
        async function SearchClickEvent(category) {
            // const posts = await GetFilterPosts(category);
            const posts = [
                {
                    id: 1,
                    imageUrl: '/icons/RedHeart.png',
                    title: 'Sample Post Title',
                    user: { nickname: 'JohnDoe' },
                    likes: 147
                }
            ];

            if (posts) {
                const mainBox = document.getElementById('postMainBox');
                mainBox.innerHTML = '';  // 기존 게시글 제거
                posts.forEach(post => {
                    const el = createPostElement(post);
                    mainBox.appendChild(el);
                });
            }
        }

        async function GetFilterPosts(category) {
            const response = await fetch(`/api/post/like/${category}`, { method: 'PATCH' });
            return await response.json();
        }

        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.classList.add('post');
            postDiv.onclick = (e) => PostClickEvent(e, post.id);

            const form = document.createElement('form');
            form.setAttribute('action', `/api/post/${post.id}`);
            form.setAttribute('method', 'get');

            const button = document.createElement('button');
            button.setAttribute('type', 'submit');
            button.classList.add('goToDetail');
            button.textContent = 'goToDetail';

            const imgDiv = document.createElement('div');
            imgDiv.classList.add('img');

            const img = document.createElement('img');
            img.setAttribute('src', post.imageUrl);
            img.style.width = '100%';
            img.style.height = '100%';
            imgDiv.appendChild(img);

            const flexDiv = document.createElement('div');
            flexDiv.classList.add('flex', 'spaceBetween');

            const textDiv = document.createElement('div');
            const titleP = document.createElement('p');
            titleP.textContent = post.title;
            titleP.classList.add('title');
            const writerP = document.createElement('p');
            writerP.textContent = post.user.nickname;
            writerP.classList.add('nickname');
            textDiv.appendChild(titleP);
            textDiv.appendChild(writerP);

            const heartDiv = document.createElement('div');
            heartDiv.classList.add('flex');

            const heartImg = document.createElement('img');
            heartImg.setAttribute('src', '/icons/RedHeart.png');
            heartImg.setAttribute('data-pid', post.id);
            heartImg.classList.add('btnHeart');
            heartImg.onclick = (e) => HeartClickEvent(e);

            const likesP = document.createElement('p');
            likesP.classList.add('likes');
            likesP.textContent = post.likes;

            heartDiv.appendChild(heartImg);
            heartDiv.appendChild(likesP);

            flexDiv.appendChild(textDiv);
            flexDiv.appendChild(heartDiv);

            form.appendChild(button);
            form.appendChild(imgDiv);
            form.appendChild(flexDiv);

            postDiv.appendChild(form);

            return postDiv;
        }

        function PostClickEvent(e, postId) {
			if(e.target.className != 'btnHeart'){
				window.location.href = `/api/post/${postId}`;	
			}
        }

        async function HeartClickEvent(e) {
            const heartImg = e.target;
            const likeElement = heartImg.nextElementSibling;
            const pid = heartImg.dataset.pid;

            const post = await UpdateLikes(pid);
            likeElement.textContent = post.likes;
        }

        async function UpdateLikes(pid) {
            const response = await fetch(`/api/post/like/${pid}`, { method: 'PATCH' });
            return await response.json();
        }
    </script>
</head>
<body>
    <div th:replace="~{fragments/nav}"></div>

    <div id="wrapBox">
        <!-- 카테고리 필터와 검색 입력 -->
        <div id="filterBox" class="flex mb20">
            <select onchange="SearchClickEvent(this.value)">
                <option th:each="category : ${categories}" th:value="${category.name}" th:text="${category.name}"></option>
            </select>
            <input id="filterInput" type="text" placeholder="검색" />
            <img id="btnSearch" src="/icons/Search.png" onclick="SearchClickEvent(document.querySelector('select').value)" />
        </div>

        <!-- 주간 상위 5개 게시글 -->
        <div id="weeklyBox" class="mb20">
            <p id="weeklyBoxTitle">Weekly Top 5</p>
            <div id="weeklyList" class="flex center">
				<div th:each="post : ${topFive}" class="post" th:onclick="|PostClickEvent(event, ${post.id})|">
	                <div class="img">
	                    <img th:src="@{${post.imageUrl}}" style="width: 100%; height: 100%;" />
	                </div>
	                <div class="flex spaceBetween">
	                    <div>
	                        <p th:text="${post.title}" class="title">title</p>
	                        <p th:text="${post.user.nickname}" class="nickname">writer</p>
	                    </div>
	                    <div class="flex">
	                        <img th:data-pid="${post.id}" class="btnHeart" src="/icons/RedHeart.png" onclick="HeartClickEvent(event)" />
	                        <p class="likes" th:text="${post.likes}">likes</p>
	                    </div>
	                </div>
	            </div>
            </div>
        </div>

        <!-- 게시글 목록 -->
        <div id="postMainBox" class="mb20">
            <div th:each="post : ${posts}" class="post" th:onclick="|PostClickEvent(event, ${post.id})|">
                <div class="img">
                    <img th:src="@{${post.imageUrl}}" style="width: 100%; height: 100%;" />
                </div>
                <div class="flex spaceBetween">
                    <div>
                        <p th:text="${post.title}" class="title">title</p>
                        <p th:text="${post.user.nickname}" class="nickname">writer</p>
                    </div>
                    <div class="flex">
                        <img th:data-pid="${post.id}" class="btnHeart" src="/icons/RedHeart.png" onclick="HeartClickEvent(event)" />
                        <p class="likes" th:text="${post.likes}">likes</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 글 작성 버튼 -->
        <form action="/posttest" method="get" style="justify-self: center;">
            <button type="submit" id="btnPost" class="greenButton">POST</button>
        </form>

        <div th:replace="~{fragments/footer}"></div>
    </div>
</body>
</html>
