<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Category</title>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

	<link rel="stylesheet" type="text/css" href="/css/category.css">
	<script th:inline="javascript">
		
		function getUserIdFromToken() {
	        let token = localStorage.getItem("token");
	        if (!token) return null;
	
	        try {
	            let payload = JSON.parse(atob(token.split('.')[1])); // Base64 ë””ì½”ë”©
	            console.log("ğŸ“Œ ë””ì½”ë”©ëœ JWT Payload:", payload); // ë””ë²„ê¹…ìš© ë¡œê·¸
	            return payload.uid || null; // âœ… "uid" ê°’ ê°€ì ¸ì˜¤ê¸°
	        } catch (error) {
	            console.error("í† í° ë””ì½”ë”© ì‹¤íŒ¨:", error);
	            return null;
	        }
	    }
	    
		// ì¹´í…Œê³ ë¦¬ ìˆ˜ì • í•¨ìˆ˜
		function editCategory(cid) {
			
			// ğŸ“Œ í† í° ê°€ì ¸ì˜¤ê¸°
	        let token = localStorage.getItem("token");
	        if (!token) {
	            alert("âŒ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”!");
	            return;
	        }
	
	        // ğŸ“Œ í† í°ì—ì„œ uid ì¶”ì¶œ
	        let userId = getUserIdFromToken();
	        if (!userId) {
	            alert("âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”!");
	            return;
	        }
			// ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ëª…
            const currentName = document.querySelector(`#category-name-${cid}`).textContent;
		    // ìˆ˜ì •í•  ì¹´í…Œê³ ë¦¬ëª… ì…ë ¥ ë°›ê¸°
		    const newName = prompt("ìƒˆ ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:", currentName);
		
			// ì‚¬ìš©ìê°€ ì·¨ì†Œ
		    if (newName === null) {
		        return;  
		    }
		
		    // ë¹ˆ ê°’ìœ¼ë¡œ í™•ì¸ì„ ëˆŒë €ì„ ê²½ìš°
		    if (newName.trim() === "") {
		        alert("ì¹´í…Œê³ ë¦¬ëª…ì€ ë¹ˆ ì¹¸ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		        return;
		    }
		
		    // PUT ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
		    axios.put(`/api/admin/category/${cid}`, `cname=${newName}`, {
		            headers: {
		                "Authorization": `Bearer ${token}`,  // Authorization í—¤ë”ì— JWT í† í° ì¶”ê°€
		                'Content-Type': 'application/x-www-form-urlencoded'
		            }
		        })
		        .then(function(response) {
		            alert("ì¹´í…Œê³ ë¦¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
		            location.reload(); // ìˆ˜ì • í›„ ìƒˆë¡œê³ ì¹¨
		        })
		        .catch(function(error) {
		            console.error("ìˆ˜ì • ì‹¤íŒ¨:", error);
		            alert("ì¹´í…Œê³ ë¦¬ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
		        });
        }

        // ì¹´í…Œê³ ë¦¬ ì‚­ì œ í•¨ìˆ˜
        function deleteCategory(cid) {
			// ğŸ“Œ í† í° ê°€ì ¸ì˜¤ê¸°
	        let token = localStorage.getItem("token");
	        if (!token) {
	            alert("âŒ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”!");
	            return;
	        }
	
	        // ğŸ“Œ í† í°ì—ì„œ uid ì¶”ì¶œ
	        let userId = getUserIdFromToken();
	        if (!userId) {
	            alert("âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”!");
	            return;
	        }
			
			
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }
            
            // DELETE ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
            axios.delete(`/api/admin/category/${cid}`, {
	            headers: {
	                "Authorization": `Bearer ${token}`  // Authorization í—¤ë”ì— JWT í† í° ì¶”ê°€
	            }
	        })
            .then(function(response) {
                alert("ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload(); // ìƒˆë¡œê³ ì¹¨
            })
            .catch(function(error) {
                console.error("ì‚­ì œ ì‹¤íŒ¨:", error);
                alert("ì¹´í…Œê³ ë¦¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }

        // ì¹´í…Œê³ ë¦¬ ì¶”ê°€ í•¨ìˆ˜
        function addCategory() {
			
			// ğŸ“Œ í† í° ê°€ì ¸ì˜¤ê¸°
	        let token = localStorage.getItem("token");
	        if (!token) {
	            alert("âŒ ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”!");
	            return;
	        }
	
	        // ğŸ“Œ í† í°ì—ì„œ uid ì¶”ì¶œ
	        let userId = getUserIdFromToken();
	        if (!userId) {
	            alert("âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”!");
	            return;
	        }
			
            const newCategory = prompt("ìƒˆ ì¹´í…Œê³ ë¦¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:");

		    if (newCategory.trim() === "") {
		        alert("ì¹´í…Œê³ ë¦¬ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
		        return;
		    }
		
		    // POST ìš”ì²­ìœ¼ë¡œ ë°ì´í„° ì „ì†¡
		    axios.post("/api/admin/category", `cname=${newCategory}`, {
		            headers: {
		                "Authorization": `Bearer ${token}`,  // Authorization í—¤ë”ì— JWT í† í° ì¶”ê°€
		                'Content-Type': 'application/x-www-form-urlencoded'
		            }
		        })
		        .then(function(response) {
		            alert("ìƒˆ ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
		            location.reload(); // ìƒˆë¡œê³ ì¹¨
		        })
		        .catch(function(error) {
		            console.error("ì¶”ê°€ ì‹¤íŒ¨:", error);
		            alert("ì¹´í…Œê³ ë¦¬ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
		        });
        }
    </script>

</head>
<body>
	<h2 class="category">Category</h2>
    <div class="row">
        <table class="table" id="category-table">
            <thead>
                <tr>
                    <th class="category col-2"><a>Category name</a></th>
                    <th class="category col-2"><a>ìˆ˜ì •</a></th>
                    <th class="category col-2"><a>ì‚­ì œ</a></th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="category : ${categories}">
                    <td class="name" id="category-cell-${category.id}">
					    <span th:id="'category-name-' + ${category.id}" th:text="${category.name}">ì¹´í…Œê³ ë¦¬ëª…</span>
					</td>
					<td class="edit">
					    <button id="edit" th:onclick="|editCategory(${category.id})|">ìˆ˜ì •</button>
					</td>
					<td class="delete">
					    <button class="delete-btn" th:onclick="|deleteCategory(${category.id})|">ì‚­ì œ</button>
					</td>
                </tr>
            </tbody>
        </table>
        <div class="add-category-btn">
            <button onclick="addCategory()">ì¹´í…Œê³ ë¦¬ ìƒì„±</button>
        </div>
    </div>
</body>
</html>